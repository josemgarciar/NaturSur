{% extends 'reservas/base.html' %}
{% load static %}

{% block content %}
<section class="hero hero-cover" style="--hero-image: url('{% static 'reservas/img/1.png' %}')">
  <div class="container hero-inner">
    <h1>Te ayudamos a alcanzar tu bienestar</h1>
    <p class="lead">Cuidado, nutrici√≥n y experiencias relajantes con esencia del Sur.</p>
    <div class="cta-row">
  <a class="btn btn-primary btn-pill" href="#reservas">Reservar</a>
  <a class="btn btn-light btn-pill" href="{{ external_shop_url }}" target="_blank" rel="noopener noreferrer">Tienda</a>
    </div>
  </div>
</section>

<section class="pricing-cards">
  <div class="container cards-grid">
    {% for o in offerings %}
    <div class="card price-card {% if forloop.first %}highlight{% endif %}">
      <div class="card-body">
        <div class="card-info">
          <h4 class="card-title">{{ o.name }}</h4>
          <div class="card-price">‚Ç¨{{ o.price_eur }}</div>
          <div class="card-duration">{{ o.duration_minutes }}‚Ä≤</div>
        </div>
        <div class="card-action">
          <form method="post" action="{% url 'reservar' %}">
            {% csrf_token %}
            <input type="hidden" name="offering" value="{{ o.id }}">
            <button class="btn btn-primary btn-pill">Reservar</button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<section id="reservas" class="booking">
  <div class="container">
    <h2>Reserva tu experiencia</h2>
    <p class="muted">Elige servicio, fecha y hora. Te confirmaremos por email.</p>

    <form class="form" method="post" action="{% url 'reservar' %}">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="alert">{{ form.non_field_errors }}</div>
      {% endif %}

      <div class="grid-2">
        <div class="form-field">
          <label for="id_name">{{ form.name.label }}</label>
          {{ form.name }}
          {{ form.name.errors }}
        </div>
        <div class="form-field">
          <label for="id_email">{{ form.email.label }}</label>
          {{ form.email }}
          {{ form.email.errors }}
        </div>
      </div>

      <div class="grid-2">
        <div class="form-field">
          <label for="id_phone">{{ form.phone.label }}</label>
          {{ form.phone }}
          {{ form.phone.errors }}
        </div>
        <div class="form-field">
          <label for="id_offering">{{ form.offering.label|default:'Oferta' }}</label>
          {{ form.offering }}
          {{ form.offering.errors }}
        </div>
      </div>

      <div class="grid-2">
        <div class="form-field">
          <label for="id_date">{{ form.date.label }}</label>
          {{ form.date }}
          {{ form.date.errors }}
        </div>
        <div class="form-field">
          <label for="id_time">{{ form.time.label }}</label>
          {% if available_times %}
            <div class="available-times">
              {% if available_times|length == 0 %}
                <p class="muted">No hay horas disponibles para la fecha seleccionada.</p>
              {% else %}
                <div class="times-grid">
                  {% for t in available_times %}
                    <label class="time-option">
                      <input type="radio" name="time" value="{{ t }}" {% if form.time.value == t %}checked{% endif %}>
                      <span class="time-label">{{ t }}</span>
                    </label>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          {% else %}
            {{ form.time }}
            {{ form.time.errors }}
          {% endif %}
        </div>
      </div>

      <div class="form-field">
        <label for="id_notes">{{ form.notes.label }}</label>
        {{ form.notes }}
        {{ form.notes.errors }}
      </div>

      <button class="btn btn-primary" type="submit">Confirmar reserva</button>
      <a class="btn btn-ghost" href="{% url 'tienda' %}">Ver tienda online</a>
    </form>
  </div>
</section>

<script>
  // Si la URL contiene ?offering=ID o un anchor #reservas, enfocamos el formulario
  (function(){
    const params = new URLSearchParams(window.location.search);
    if(params.get('offering') || window.location.hash === '#reservas'){
      const el = document.getElementById('reservas');
      if(el) el.scrollIntoView({behavior:'smooth'});
    }
  })();
</script>

<script>
  // When the user selects an offering and a date, reload the page with those
  // params so the server can compute available times and render them.
  (function(){
    const dateEl = document.getElementById('id_date');
    const offeringEl = document.getElementById('id_offering');
    function reloadIfBoth(){
      const d = dateEl ? dateEl.value : '';
      const o = offeringEl ? offeringEl.value : '';
      if(o && d){
        const u = new URL(window.location.href);
        u.searchParams.set('offering', o);
        u.searchParams.set('date', d);
        window.location.href = u.pathname + '?' + u.searchParams.toString() + '#reservas';
      }
    }
    if(dateEl) dateEl.addEventListener('change', reloadIfBoth);
    if(offeringEl) offeringEl.addEventListener('change', function(){ setTimeout(reloadIfBoth, 10); });
  })();
</script>

<section class="social">
  <div class="container">
    <h2>√öltimas publicaciones</h2>
    <p class="muted">S√≠guenos en redes para novedades, bienestar y estilo de vida.</p>

    <div class="social-grid">
      <!-- YouTube -->
      <div class="social-col">
        <div class="social-col-header">
          <h3>‚ñ∂Ô∏è √öltimos V√≠deos YouTube</h3>
          <a class="link" href="{{ youtube_channel_url }}" target="_blank" rel="noopener">Ver canal</a>
        </div>

        {% if youtube_videos %}
          <div class="cards">
            {% for v in youtube_videos %}
              <a class="card" href="{{ v.url }}" target="_blank" rel="noopener">
                <div class="thumb" style="background-image:url('{{ v.image }}')"></div>
                <div class="card-body">
                  <div class="card-title">{{ v.title }}</div>
                </div>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty">
            <p class="muted">No se pudieron cargar los v√≠deos ahora.</p>
            <a class="btn btn-ghost" href="{{ youtube_channel_url }}" target="_blank" rel="noopener">Ir al canal</a>
          </div>
        {% endif %}
      </div>

      <!-- Instagram -->
      <div class="social-col">
        <div class="social-col-header">
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:24px">üì∏</span>
            <h3 style="margin:0;font-size:22px;font-weight:700">Instagram</h3>
          </div>
          <a class="link" href="{{ instagram_profile_url }}" target="_blank" rel="noopener">@yosoyescalona</a>
        </div>

        <div class="instagram-embed-wrapper">
          <iframe src="https://www.instagram.com/yosoyescalona/embed" width="100%" height="600" frameborder="0" scrolling="no" allowtransparency="true"></iframe>
        </div>
      </div>

      <!-- Facebook Page Plugin -->
      <div class="social-col">
        <div class="social-col-header">
          <h3>f S√≠guenos en Facebook</h3>
          <a class="link" href="{{ facebook_page_url }}" target="_blank" rel="noopener">Visitar p√°gina</a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Facebook SDK (solo para esta p√°gina) -->
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/es_ES/sdk.js#xfbml=1&version=v18.0" nonce="ns"></script>

<script>
  // Slideshow sencillo de portada si existen im√°genes 1‚Äì4 en static/reservas/img/
  (function(){
    const images = [
      "{% static 'reservas/img/1.png' %}",
      "{% static 'reservas/img/2.png' %}",
      "{% static 'reservas/img/3.png' %}",
      "{% static 'reservas/img/4.png' %}",
    ];
    let i = 0;
    const hero = document.querySelector('.hero.hero-cover');
    function next(){
      i = (i+1) % images.length;
      hero.style.setProperty('--hero-image', `url('${images[i]}')`);
    }
    setInterval(next, 6000);
  })();
</script>
{% endblock %}
