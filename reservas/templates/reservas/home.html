{% extends 'reservas/base.html' %}
{% load static %}

{% block content %}
<section class="hero hero-cover" style="--hero-image: url('{% static 'reservas/img/1.png' %}')">
  <div class="hero-bg-layer" aria-hidden="true"></div>
  <div class="hero-bg-layer" aria-hidden="true"></div>
  <div class="container hero-inner">
    <h1>Te ayudamos a alcanzar tu bienestar</h1>
    <p class="lead">Cuidado, nutrici√≥n y experiencias relajantes con esencia del Sur.</p>
    <div class="cta-row">
  <a class="btn btn-primary btn-pill" href="#reservas">Reservar</a>
  <a class="btn btn-light btn-pill" href="{{ external_shop_url }}" target="_blank" rel="noopener noreferrer">Tienda</a>
    </div>
  </div>
</section>

<section class="pricing-cards">
  <div class="container cards-grid">
    {% for o in offerings %}
    <div class="card price-card {% if forloop.first %}highlight{% endif %}">
      <div class="card-body">
        <div class="card-info">
          <h4 class="card-title">{{ o.name }}</h4>
          <div class="card-price">‚Ç¨{{ o.price_eur }}</div>
          <div class="card-duration">{{ o.duration_minutes }}‚Ä≤</div>
        </div>
        <div class="card-action">
          <form method="post" action="{% url 'reservar' %}">
            {% csrf_token %}
            <input type="hidden" name="offering" value="{{ o.id }}">
            <button class="btn btn-primary btn-pill">Reservar</button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<section id="reservas" class="booking">
  <div class="container">
    <h2>Reserva tu experiencia</h2>
    <p class="muted">Elige servicio, fecha y hora. Te confirmaremos por email.</p>

    <form class="form" method="post" action="{% url 'reservar' %}">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="alert">{{ form.non_field_errors }}</div>
      {% endif %}

      <div class="grid-2">
        <div class="form-field">
          <label for="id_name">{{ form.name.label }}</label>
          {{ form.name }}
          {{ form.name.errors }}
        </div>
        <div class="form-field">
          <label for="id_email">{{ form.email.label }}</label>
          {{ form.email }}
          {{ form.email.errors }}
        </div>
      </div>

      <div class="grid-2">
        <div class="form-field">
          <label for="id_phone">{{ form.phone.label }}</label>
          {{ form.phone }}
          {{ form.phone.errors }}
        </div>
        <div class="form-field">
          <label for="id_offering">{{ form.offering.label|default:'Oferta' }}</label>
          {{ form.offering }}
          {{ form.offering.errors }}
        </div>
      </div>

      <div class="grid-2">
        <div class="form-field">
          <label for="id_date">{{ form.date.label }}</label>
          {{ form.date }}
          <p class="muted" style="font-size:13px;margin-top:6px;">Las fechas anteriores a hoy est√°n deshabilitadas.</p>
          {{ form.date.errors }}
        </div>
      
      <div class="form-field">
          <label for="id_time">{{ form.time.label }}</label>
          <div class="form-field">
            {% if selected_date %}
              {% if available_times is not none %}
                {% if available_times|length == 0 %}
                  <p class="muted">No hay horas disponibles para la fecha seleccionada.</p>
                {% else %}
                  <select name="time" id="id_time" class="form-select">
                    <option value="">-- Elige una hora --</option>
                    {% for t in available_times %}
                      <option value="{{ t }}" {% if form.time.value == t %}selected{% endif %}>{{ t }}</option>
                    {% endfor %}
                  </select>
                {% endif %}
              {% else %}
                <p class="muted">No se pudo calcular las horas disponibles. Intenta de nuevo.</p>
              {% endif %}
            {% else %}
              <select name="time" id="id_time" class="form-select" disabled>
                <option value="">Selecciona una fecha primero</option>
                {% for t in all_slots %}
                  <option value="{{ t }}" disabled>{{ t }}</option>
                {% endfor %}
              </select>
            {% endif %}
          </div>
          {{ form.time.errors }}
        </div>
      </div>

      <div class="form-field">
        <label for="id_notes">{{ form.notes.label }}</label>
        {{ form.notes }}
        {{ form.notes.errors }}
      </div>

      <button class="btn btn-primary" type="submit">Confirmar reserva</button>
      <a class="btn btn-ghost" href="{% url 'tienda' %}">Ver tienda online</a>
    </form>
  </div>
</section>

<script>
  // Si la URL contiene ?offering=ID o un anchor #reservas, enfocamos el formulario
  (function(){
    const params = new URLSearchParams(window.location.search);
    if(params.get('offering') || window.location.hash === '#reservas'){
      const el = document.getElementById('reservas');
      if(el) el.scrollIntoView({behavior:'smooth'});
    }
  })();
</script>

<script>
  // When the user selects an offering and a date, reload the page with those
  // params so the server can compute available times and render them.
  (function(){
    const dateEl = document.getElementById('id_date');
    const offeringEl = document.getElementById('id_offering');
    // small inline hint element to guide user when needed
    function ensureHintContainer(){
      let c = document.getElementById('time-hint');
      if(!c){
        c = document.createElement('div');
        c.id = 'time-hint';
        c.style.marginTop = '6px';
        c.style.fontSize = '13px';
        c.style.color = 'var(--muted)';
        const parent = document.querySelector('#reservas .form .form-field:nth-child(3)') || document.querySelector('#reservas .form .form-field');
        // append near time field
        const timeField = document.getElementById('id_time');
        if(timeField && timeField.parentNode){
          timeField.parentNode.insertBefore(c, timeField.nextSibling);
        } else if(parent){
          parent.appendChild(c);
        }
      }
      return c;
    }

    async function fetchAndPopulate(){
      const d = dateEl ? dateEl.value : '';
      const o = offeringEl ? offeringEl.value : '';
      const hint = ensureHintContainer();
      hint.textContent = '';
      const timeSelect = document.getElementById('id_time');
      if(!timeSelect) return;
      // If user selected date but no offering, ask to choose offering
      if(d && !o){
        hint.textContent = 'Selecciona una oferta para calcular las horas disponibles.';
        timeSelect.innerHTML = '<option value="">Selecciona una fecha y oferta</option>';
        timeSelect.disabled = true;
        return;
      }
      if(!d || !o){
        // reset to disabled placeholder
        timeSelect.innerHTML = '<option value="">Selecciona una fecha primero</option>';
        timeSelect.disabled = true;
        return;
      }

      // Fetch available times from API
      try{
        const q = new URLSearchParams({offering: o, date: d});
        const res = await fetch(`{% url 'available_times_api' %}?${q.toString()}`);
        if(!res.ok) throw new Error('network');
        const data = await res.json();
        const times = data.times || [];
        if(times.length === 0){
          hint.textContent = 'No hay horas disponibles para la fecha seleccionada.';
          timeSelect.innerHTML = '<option value="">No hay horas disponibles</option>';
          timeSelect.disabled = true;
        } else {
          let html = '<option value="">-- Elige una hora --</option>';
          for(const t of times){
            html += `<option value="${t}">${t}</option>`;
          }
          timeSelect.innerHTML = html;
          timeSelect.disabled = false;
          // preserve previous selection if present
          try{
            const prev = '{{ form.time.value|default:"" }}';
            if(prev){ timeSelect.value = prev; }
          } catch(e){}
        }
      }catch(e){
        hint.textContent = 'No se pudo calcular las horas disponibles. Intenta de nuevo.';
        timeSelect.disabled = true;
      }
    }

    if(dateEl) dateEl.addEventListener('change', fetchAndPopulate);
    if(offeringEl) offeringEl.addEventListener('change', function(){ setTimeout(fetchAndPopulate, 10); });
  })();
</script>

  <script>
    // Ensure the time select is disabled unless a date is chosen.
    (function(){
      function toggleTime(){
        const dateEl = document.getElementById('id_date');
        const timeEl = document.getElementById('id_time');
        if(!timeEl) return;
        const hasDate = dateEl && dateEl.value;
        // If hasDate truthy, enable only if there are real options
        if(hasDate){
          // enable if there is at least one non-empty option
          const hasOption = Array.from(timeEl.options).some(opt => opt.value && !opt.disabled);
          timeEl.disabled = !hasOption;
        } else {
          timeEl.disabled = true;
        }
      }
      document.addEventListener('DOMContentLoaded', toggleTime);
      document.addEventListener('change', function(e){
        if(e.target && (e.target.id === 'id_date' || e.target.id === 'id_offering')){
          // small timeout to allow server+reload flows; still safe for client-side changes
          setTimeout(toggleTime, 10);
        }
      });
    })();
  </script>

<section class="social">
  <div class="container">
    <h2>√öltimas publicaciones</h2>
    <p class="muted">S√≠guenos en redes para novedades, bienestar y estilo de vida.</p>

    <div class="social-grid">
      <!-- YouTube -->
      <div class="social-col">
        <div class="social-col-header">
          <h3>‚ñ∂Ô∏è √öltimos V√≠deos YouTube</h3>
          <a class="link" href="{{ youtube_channel_url }}" target="_blank" rel="noopener">Ver canal</a>
        </div>

        {% if youtube_videos %}
          <div class="cards">
            {% for v in youtube_videos %}
              <a class="card" href="{{ v.url }}" target="_blank" rel="noopener">
                <div class="thumb" style="background-image:url('{{ v.image }}')"></div>
                <div class="card-body">
                  <div class="card-title">{{ v.title }}</div>
                </div>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty">
            <p class="muted">No se pudieron cargar los v√≠deos ahora.</p>
            <a class="btn btn-ghost" href="{{ youtube_channel_url }}" target="_blank" rel="noopener">Ir al canal</a>
          </div>
        {% endif %}
      </div>

      <!-- Instagram -->
      <div class="social-col">
        <div class="social-col-header">
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:24px">üì∏</span>
            <h3 style="margin:0;font-size:22px;font-weight:700">Instagram</h3>
          </div>
          <a class="link" href="{{ instagram_profile_url }}" target="_blank" rel="noopener">@yosoyescalona</a>
        </div>

        <div class="instagram-embed-wrapper">
          <iframe src="https://www.instagram.com/yosoyescalona/embed" width="100%" height="600" frameborder="0" scrolling="auto" allowtransparency="true"></iframe>
        </div>
      </div>

      <!-- Facebook Page Plugin -->
      <div class="social-col">
        <div class="social-col-header">
          <h3>f S√≠guenos en Facebook</h3>
          <a class="link" href="{{ facebook_page_url }}" target="_blank" rel="noopener">Visitar p√°gina</a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Facebook SDK (solo para esta p√°gina) -->
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/es_ES/sdk.js#xfbml=1&version=v18.0" nonce="ns"></script>

<script>
  // Slideshow con crossfade + efecto Ken Burns en capas de fondo
  (function(){
    const images = [
      "{% static 'reservas/img/1.png' %}",
      "{% static 'reservas/img/2.png' %}",
      "{% static 'reservas/img/3.png' %}",
      "{% static 'reservas/img/4.png' %}",
    ];
    const hero = document.querySelector('.hero.hero-cover');
    const layers = hero ? hero.querySelectorAll('.hero-bg-layer') : [];
    if(!hero || layers.length < 2) return;

    // Estado
    let imgIndex = 0;      // √≠ndice de imagen actual
    let activeLayer = 0;   // 0 o 1 para la capa activa

    // Inicializa las dos primeras capas
    layers[0].style.backgroundImage = `url('${images[0]}')`;
    layers[0].classList.add('is-active');
    layers[1].style.backgroundImage = `url('${images[1 % images.length]}')`;

    function preload(src){
      return new Promise(resolve => {
        const img = new Image();
        img.onload = resolve;
        img.onerror = resolve; // No bloquear si falla
        img.src = src;
      });
    }

    async function next(){
      const nextIndex = (imgIndex + 1) % images.length;
      const nextLayer = 1 - activeLayer; // alternar entre 0 y 1
      await preload(images[nextIndex]);
      layers[nextLayer].style.backgroundImage = `url('${images[nextIndex]}')`;
      // Crossfade + suave zoom
      layers[activeLayer].classList.remove('is-active');
      layers[nextLayer].classList.add('is-active');
      activeLayer = nextLayer;
      imgIndex = nextIndex;

      // Prepara en segundo plano la siguiente imagen
      const afterNext = (imgIndex + 1) % images.length;
      preload(images[afterNext]);
    }

    setInterval(next, 6000);
  })();
</script>
{% endblock %}
